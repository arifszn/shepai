name: Release

on:
  push:
    tags:
      - 'v*'

jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    strategy:
      matrix:
        include:
          - goos: linux
            goarch: amd64
            name: linux-amd64
          - goos: linux
            goarch: arm64
            name: linux-arm64
          - goos: darwin
            goarch: amd64
            name: darwin-amd64
          - goos: darwin
            goarch: arm64
            name: darwin-arm64
          - goos: windows
            goarch: amd64
            name: windows-amd64
            ext: .exe
            output_name: shepai.exe
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: '1.21'
    
    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: 'lts/*'
    
    - name: Install frontend dependencies
      run: cd frontend && npm ci
    
    - name: Build frontend
      run: cd frontend && npm run build
    
    - name: Build binary
      env:
        GOOS: ${{ matrix.goos }}
        GOARCH: ${{ matrix.goarch }}
        VERSION: ${{ github.ref_name }}
      run: |
        set -euo pipefail
        mkdir -p release

        if [ "${{ matrix.goos }}" = "windows" ]; then
          BIN_IN_ARCHIVE="shepai.exe"
          CGO_ENABLED=0 GOOS="${GOOS}" GOARCH="${GOARCH}" \
            go build -trimpath -ldflags="-s -w -buildid= -X main.version=${VERSION}" -o "${BIN_IN_ARCHIVE}" ./cmd/shepai

          # Compressed release artifacts (smaller download)
          zip -q "release/shepai-${{ matrix.name }}.zip" "${BIN_IN_ARCHIVE}"
          tar -czf "release/shepai-${{ matrix.name }}.tar.gz" "${BIN_IN_ARCHIVE}"
        else
          BIN_IN_ARCHIVE="shepai-${{ matrix.name }}"
          CGO_ENABLED=0 GOOS="${GOOS}" GOARCH="${GOARCH}" \
            go build -trimpath -ldflags="-s -w -buildid= -X main.version=${VERSION}" -o "${BIN_IN_ARCHIVE}" ./cmd/shepai

          # Compressed release artifacts (smaller download)
          zip -q "release/${BIN_IN_ARCHIVE}.zip" "${BIN_IN_ARCHIVE}"
          tar -czf "release/${BIN_IN_ARCHIVE}.tar.gz" "${BIN_IN_ARCHIVE}"
        fi
    
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: shepai-${{ matrix.name }}
        path: |
          release/*.tar.gz
          release/*.zip
        retention-days: 30
  
  create-release:
    needs: release
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: artifacts
    
    - name: Create checksums
      run: |
        cd artifacts
        find . -type f \( -name '*.tar.gz' -o -name '*.zip' \) -exec sha256sum {} \; | sed 's|\./||' > checksums.txt
        cat checksums.txt
    
    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        files: |
          artifacts/**/*.tar.gz
          artifacts/**/*.zip
          artifacts/checksums.txt
        generate_release_notes: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

